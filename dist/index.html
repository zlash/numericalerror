<!DOCTYPE html><p><script>const e=[0,3,3,-3,-3,-3,-5,0,-3,3,3,3,5,0];let t={};let n=0,o=[0,1,0],v=[0,0,-1];function r(e){let c=t.t;const i=(e*=.001)-n;if(n=e,c.clear(c.COLOR_BUFFER_BIT),c.bindBuffer(c.ARRAY_BUFFER,t.o),c.vertexAttribPointer(t.v,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(t.v),c.useProgram(t.i),V=g,k=I,g=0,I=0,0!=V){let e=m([0,1,0],i*-V);v=y(v=function(e,t,n,o=[0,0,0]){let v=[...t,n];for(let t=0;t<3;t++){o[t]=0;for(let n=0;n<4;n++)o[t]+=e[4*n+t]*v[n]}return o}(e,v,0))}let a=u(v,i),f=z(v,[0,1,0]);f=u(y(f),i),R(h)&&(o=s(o,a,o)),R(p)&&(o=l(o,a,o)),R(M)&&(o=l(o,f,o)),R(b)&&(o=s(o,f,o));let d=function(e,t,n,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){let v=y(l(t,e)),r=y(z(v,n)),c=z(r,v);return o[0]=r[0],o[4]=r[1],o[8]=r[2],o[1]=c[0],o[5]=c[1],o[9]=c[2],o[2]=-v[0],o[6]=-v[1],o[10]=-v[2],o[12]=-x(r,e),o[13]=-x(c,e),o[14]=x(v,e),o}(o,s(o,v),[0,1,0]),w=function(e,t,n,o,v,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const c=Math.cos(.5*e)/Math.sin(.5*e),i=c*n/t;return r[0]=i,r[5]=c,r[10]=-(v+o)/(v-o),r[11]=-1,r[14]=-2*v*o/(v-o),r}(.5*Math.PI,t.t.canvas.height,t.t.canvas.width,.1,100);c.uniformMatrix4fv(t.m,!1,d),c.uniformMatrix4fv(t.s,!1,w),c.drawArrays(c.TRIANGLE_STRIP,0,4),requestAnimationFrame(r)}function c(e,t,n){const o=e.createShader(t);return e.shaderSource(o,n),e.compileShader(o),o}function i(e,t,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){for(let o=0;o<4;o++)for(let v=0;v<4;v++){let r=4*v+o;n[r]=0;for(let c=0;c<4;c++)n[r]+=e[4*c+o]*t[4*v+c]}return n}function a(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){return t[12]=e[0],t[13]=e[1],t[14]=e[2],t}function m(e,t,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const o=Math.cos(t),v=Math.sin(t),r=1-o;return n[0]=o+e[0]*e[0]*r,n[1]=e[0]*e[1]*r+e[2]*v,n[2]=e[0]*e[2]*r-e[1]*v,n[4]=e[0]*e[1]*r-e[2]*v,n[5]=o+e[1]*e[1]*r,n[6]=e[1]*e[2]*r+e[0]*v,n[8]=e[0]*e[2]*r+e[1]*v,n[9]=e[1]*e[2]*r-e[0]*v,n[10]=o+e[2]*e[2]*r,n}function f(e){return`mat4(${e.map(e=>$(e)).join(",")})`}function s(e,t,n=[0,0,0]){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n}function l(e,t,n=[0,0,0]){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function u(e,t,n=[0,0,0]){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function x(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function d(e){return Math.sqrt(x(e,e))}function y(e,t=[0,0,0]){let n=d(e);return t[0]=e[0]/n,t[1]=e[1]/n,t[2]=e[2]/n,t}function z(e,t,n=[0,0,0]){return n[0]=e[1]*t[2]-e[2]*t[1],n[1]=e[2]*t[0]-e[0]*t[2],n[2]=e[0]*t[1]-e[1]*t[0],n}window.onload=function(){const n=document.createElement("canvas");let o=n.getContext("webgl");t.t=o,n.width=800,n.height=600,t.t.viewport(0,0,t.t.canvas.width,t.t.canvas.height),document.body.appendChild(n),o.clearColor(0,1,0,1);var v=function(e,t,n){const o=c(e,e.VERTEX_SHADER,t),v=c(e,e.FRAGMENT_SHADER,n),r=e.createProgram();e.attachShader(r,o),e.attachShader(r,v),e.linkProgram(r),!1;return r}(o,O,A);t.v=o.getAttribLocation(v,"aVertexPosition"),t.s=o.getUniformLocation(v,"uProjectionMatrix"),t.m=o.getUniformLocation(v,"uModelViewMatrix"),t.i=v,function(e){const n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,1,1,1,-1]),e.STATIC_DRAW),t.o=n}(o),function(e){let t=[],n=[];for(let t=2;t<e.length;t+=2)n.push([e[t],0,e[t+1]]);n.push(n[0]);for(let e=0;e<n.length-1;e++){let o=l(n[e],n[e+1]),v=d(o),r=a(n[e+1]);r=i(r,m([0,1,0],Math.atan2(-o[2],o[0]))),r=i(r,a([.5*v,0,0])),t.push(`sdfWall(vec3(matInverse(${f(r)})*vec4(pos,1.0)), vec2(${$(.5*v)},1.0))`)}t.reduce((e,t)=>`min(${e},${t})`)}(e),document.body.addEventListener("keydown",P,!1),document.body.addEventListener("keyup",B,!1),document.addEventListener("pointerlockchange",S,!1),document.addEventListener("mozpointerlockchange",S,!1),n.addEventListener("click",()=>(function(){let e=t.t.canvas;e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock,e.requestPointerLock()})(),!1),requestAnimationFrame(r)};let V,k,w={},h="KeyW",p="KeyS",M="KeyA",b="KeyD",g=0,I=0;function P(e){w[e.code]=!0}function B(e){w[e.code]=!1}function W(e){e.movementX&&(g+=e.movementX),e.movementY&&(I+=e.movementY)}function S(){document.pointerLockElement===t.t.canvas||document.mozPointerLockElement===t.t.canvas?document.addEventListener("mousemove",W,!1):document.removeEventListener("mousemove",W,!1)}function R(e){return!!w[e]}function $(e){return`${e}${e===Math.trunc(e)?".0":""}`}let O="precision highp float;\nattribute vec4 aVertexPosition;uniform mat4 uProjectionMatrix;varying vec2 vUvs;varying vec4 vViewVector;mat4 matInverse(mat4 v){return mat4(v[0][0],v[1][0],v[2][0],0.,v[0][1],v[1][1],v[2][1],0.,v[0][2],v[1][2],v[2][2],0.,-dot(v[0].xyz,v[3].xyz),-dot(v[1].xyz,v[3].xyz),-dot(v[2].xyz,v[3].xyz),1.);}void main(){vUvs=(aVertexPosition.xy+vec2(1.))*.5,vViewVector=matInverse(uProjectionMatrix)*vec4(aVertexPosition.xy,1.,1.),vViewVector/=vViewVector.w,gl_Position=vec4(aVertexPosition.xy,0.,1.);}",A="precision highp float;\nvarying vec2 vUvs;varying vec4 vViewVector;uniform mat4 uModelViewMatrix;float sdfPlane(vec3 m,vec3 v){return dot(m,v);}float sdfBox(vec3 m,vec3 s){vec3 v=abs(m)-s;return length(max(v,0.))+min(max(v.x,max(v.y,v.z)),0.);}float sdfRoundedBox(vec3 m,vec3 s,float v){vec3 f=abs(m)-s;return length(max(f,0.))-v+min(max(f.x,max(f.y,f.z)),0.);}float sdfOpIntersection(float m,float v){return max(m,v);}vec3 sdfOpRepeat(vec3 m,vec3 v){return mod(m,v)-.5*v;}float sdfOpSmoothUnion(float v,float m,float s){float f=clamp(.5+.5*(m-v)/s,0.,1.);return mix(m,v,f)-s*f*(1.-f);}const vec3 brickSize=vec3(.3,.13,.03);float sdfBrick4x4(vec3 m){const float v=.95;vec3 s=sdfOpRepeat(m,vec3(brickSize.xy*4.,0.));return sdfRoundedBox(s,brickSize*vec3(.8*v,.5*v,1.),.05);}float sdfBrickRow(vec3 m){return min(sdfBrick4x4(m),sdfBrick4x4(m-vec3(brickSize.x*2.,0.,0.)));}float sdfWall(vec3 m,vec2 v){float s=sdfPlane(m,vec3(0.,0.,1.)),f=min(sdfBrickRow(m),sdfBrickRow(m-vec3(brickSize.x,brickSize.y*2.,0.)));return sdfOpIntersection(min(s,f),sdfBox(m,vec3(v,.5)));}mat4 matInverse(mat4 v){return mat4(v[0][0],v[1][0],v[2][0],0.,v[0][1],v[1][1],v[2][1],0.,v[0][2],v[1][2],v[2][2],0.,-dot(v[0].xyz,v[3].xyz),-dot(v[1].xyz,v[3].xyz),-dot(v[2].xyz,v[3].xyz),1.);}vec2 room(vec3 m){float v=min(min(min(min(min(sdfWall(vec3(matInverse(mat4(1.,0.,0.,0.,0.,1.,0.,0.,0.,0.,1.,0.,0.,0.,-3.,1.))*vec4(m,1.)),vec2(3.,1.)),sdfWall(vec3(matInverse(mat4(.5547,0.,-.83205,0.,0.,1.,0.,0.,.83205,0.,.5547,0.,-4.,0.,-1.5,1.))*vec4(m,1.)),vec2(1.80278,1.))),sdfWall(vec3(matInverse(mat4(-.5547,0.,-.83205,0.,0.,1.,0.,0.,.83205,0.,-.5547,0.,-4.,0.,1.5,1.))*vec4(m,1.)),vec2(1.80278,1.))),sdfWall(vec3(matInverse(mat4(-1.,0.,1.22465e-16,0.,0.,1.,0.,0.,-1.22465e-16,0.,-1.,0.,0.,0.,3.,1.))*vec4(m,1.)),vec2(3.,1.))),sdfWall(vec3(matInverse(mat4(-.5547,0.,.83205,0.,0.,1.,0.,0.,-.83205,0.,-.5547,0.,4.,0.,1.5,1.))*vec4(m,1.)),vec2(1.80278,1.))),sdfWall(vec3(matInverse(mat4(.5547,0.,.83205,0.,0.,1.,0.,0.,-.83205,0.,.5547,0.,4.,0.,-1.5,1.))*vec4(m,1.)),vec2(1.80278,1.)));return vec2(v,-1.);}vec3 calcNormal(in vec3 m){const float v=.0001;vec2 s=vec2(1.,-1.)*.5773;return normalize(s.xyy*room(m+s.xyy*v).x+s.yyx*room(m+s.yyx*v).x+s.yxy*room(m+s.yxy*v).x+s.xxx*room(m+s.xxx*v).x);}float shadow(vec3 m,vec3 s,float v,float f){float z=1.,r=v;for(int i=0;i<32;i++){float x=room(m+s*r).x;z=min(z,10.*x/r);r+=x;if(abs(x)<.001||r>f)break;}return step(.01,z);}void main(){const float v=3.;vec3 m=vec3(0.),f;vec2 s;float r=.1;mat4 x=matInverse(uModelViewMatrix);vec3 y=normalize(vViewVector.xyz);for(int i=0;i<64;i++){f=y*r;f=vec3(x*vec4(f,1.));s=room(f);float z=s.x;if(abs(z)<.001||r>20.)break;r+=z;}if(r<20.){vec3 z=normalize(vec3(1.,1.,1.));if(s.y>0.)m=vec3(1.,0.,0.);else m=vec3(.6);vec3 i=calcNormal(f);float e=1.;e*=max(0.,dot(z,i));m*=min(1.,.4+e);}gl_FragColor=vec4(m.xyz,1.);}";</script>
